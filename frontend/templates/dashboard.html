{% extends "base.html" %}
{% block title %}Dashboard - Vulnerability Scanner{% endblock %}
{% block content %}
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 text-white mb-1">
            <i class="bi bi-speedometer2 me-2"></i>
            Security Dashboard
        </h1>
        <p class="text-white-50 mb-0">Monitor your container security posture</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-light" onclick="showScanModal()" data-auto-refresh="true">
            <i class="bi bi-search me-1"></i>
            Quick Scan
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card gradient-card">
            <div class="card-body text-center text-white">
                <i class="bi bi-file-earmark-text fs-1 mb-3"></i>
                <h3 class="mb-1">{{ stats.total_scans or 0 }}</h3>
                <p class="mb-0">Total Scans</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card severity-critical">
            <div class="card-body text-center text-white">
                <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                <h3 class="mb-1">{{ stats.vulnerability_totals.total_critical or 0 }}</h3>
                <p class="mb-0">Critical Issues</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card severity-high">
            <div class="card-body text-center text-white">
                <i class="bi bi-shield-exclamation fs-1 mb-3"></i>
                <h3 class="mb-1">{{ stats.vulnerability_totals.total_high or 0 }}</h3>
                <p class="mb-0">High Risk</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card severity-low">
            <div class="card-body text-center text-white">
                <i class="bi bi-calendar-week fs-1 mb-3"></i>
                <h3 class="mb-1">{{ stats.recent_scans_7d or 0 }}</h3>
                <p class="mb-0">Recent (7d)</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Scan Form -->
<div class="scan-form mb-4">
    <form method="POST" action="/">
        <h5 class="mb-3">
            <i class="bi bi-search me-2"></i>
            Run Vulnerability Scan
        </h5>
        <div class="row g-3">
            <div class="col-md-8">
                <input type="text" name="image" class="form-control form-control-lg" 
                       placeholder="Enter Docker image (e.g., nginx:latest, ubuntu:22.04)" required>
            </div>
            <div class="col-md-2">
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="enrich_cve" checked>
                    <label class="form-check-label">
                        CVE Enhanced
                    </label>
                </div>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-gradient btn-lg w-100">
                    <i class="bi bi-play-fill me-1"></i>
                    Scan Now
                </button>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Popular images: nginx:latest, mysql:8.0, python:3.11, node:20, ubuntu:22.04
            </small>
        </div>
    </form>
</div>

<!-- Recent Reports -->
<div class="card">
    <div class="card-header bg-transparent">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-clock-history me-2"></i>
                Recent Scan Reports
            </h5>
            <a href="{{ url_for('reports_list') }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-right me-1"></i>
                View All Reports
            </a>
        </div>
    </div>
    <div class="card-body p-0">
        {% if reports %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th><i class="bi bi-box me-1"></i>Image</th>
                            <th><i class="bi bi-shield-check me-1"></i>Risk Level</th>
                            <th><i class="bi bi-bug me-1"></i>Vulnerabilities</th>
                            <th><i class="bi bi-clock me-1"></i>Scanned</th>
                            <th><i class="bi bi-gear me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-box text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">{{ report.image }}</div>
                                        {% if report.enriched %}
                                            <small class="text-success">
                                                <i class="bi bi-database me-1"></i>CVE Enhanced
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% set risk_level, risk_class = report.summary | risk_level %}
                                <span class="badge bg-{{ risk_class }}">{{ risk_level }}</span>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    {% if report.summary.CRITICAL > 0 %}
                                        <span class="badge bg-danger">{{ report.summary.CRITICAL }}C</span>
                                    {% endif %}
                                    {% if report.summary.HIGH > 0 %}
                                        <span class="badge bg-warning">{{ report.summary.HIGH }}H</span>
                                    {% endif %}
                                    {% if report.summary.MEDIUM > 0 %}
                                        <span class="badge bg-info">{{ report.summary.MEDIUM }}M</span>
                                    {% endif %}
                                    {% if report.summary.LOW > 0 %}
                                        <span class="badge bg-success">{{ report.summary.LOW }}L</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">{{ report.created_at | datetime }}</small>
                            </td>
                            <td>
                                <a href="{{ url_for('report', report_id=report.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>
                                    View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox fs-1 mb-3"></i>
                <h5>No scans yet</h5>
                <p>Run your first vulnerability scan to get started</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}