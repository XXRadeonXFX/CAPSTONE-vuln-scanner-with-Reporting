{% extends "base.html" %}

{% block title %}Registry Manager - Container Vulnerability Scanner{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-white">Dashboard</a></li>
                <li class="breadcrumb-item active text-white-50">Registry Manager</li>
            </ol>
        </nav>
        <h1 class="h2 text-white mb-1">
            <i class="bi bi-server me-2"></i>
            Docker Registry Manager
        </h1>
        <p class="text-white-50 mb-0">Manage and scan Docker registry repositories</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light" onclick="refreshRegistryData()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Refresh
        </button>
        <button class="btn btn-light" onclick="startBatchScan()">
            <i class="bi bi-play-fill me-1"></i>
            Start Batch Scan
        </button>
    </div>
</div>

<!-- Registry Information -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Registry Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Registry URL:</dt>
                            <dd class="col-sm-8"><code>{{ registry_data.registry_url or 'Not configured' }}</code></dd>
                            <dt class="col-sm-4">Repositories:</dt>
                            <dd class="col-sm-8">{{ registry_data.count or 0 }}</dd>
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                {% if registry_data.repositories %}
                                    <span class="badge bg-success">Connected</span>
                                {% else %}
                                    <span class="badge bg-danger">Disconnected</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Scan Statistics</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total Scans:</strong> {{ stats.total_scans or 0 }}</li>
                            <li><strong>Registry Scans:</strong> {{ stats.registry_batch_scans or 0 }}</li>
                            <li><strong>Single Scans:</strong> {{ stats.single_image_scans or 0 }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body d-grid gap-2">
                <button class="btn btn-gradient" onclick="scanPopularImages()">
                    <i class="bi bi-stars me-1"></i>
                    Scan Popular Images
                </button>
                <button class="btn btn-outline-primary" onclick="customRegistryScan()">
                    <i class="bi bi-sliders me-1"></i>
                    Custom Scan
                </button>
                <button class="btn btn-outline-secondary" onclick="exportRepositoryList()">
                    <i class="bi bi-download me-1"></i>
                    Export Repository List
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Repository Browser -->
<div class="card">
    <div class="card-header bg-transparent">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-list me-2"></i>
                Available Repositories ({{ registry_data.count or 0 }})
            </h5>
            <div class="d-flex gap-2">
                <div class="input-group input-group-sm" style="width: 250px;">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="repositorySearch" 
                           placeholder="Search repositories..." onkeyup="filterRepositories()">
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectAllVisible()">
                    Select All
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if registry_data.repositories %}
        <div class="repository-grid" style="max-height: 600px; overflow-y: auto;">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllRepositories()">
                            </th>
                            <th><i class="bi bi-box me-1"></i>Repository Name</th>
                            <th><i class="bi bi-tag me-1"></i>Actions</th>
                            <th><i class="bi bi-clock me-1"></i>Last Scanned</th>
                        </tr>
                    </thead>
                    <tbody id="repositoryTableBody">
                        {% for repo in registry_data.repositories %}
                        <tr class="repository-row" data-repository="{{ repo }}">
                            <td>
                                <input type="checkbox" class="repository-checkbox" value="{{ repo }}">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-box text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">{{ repo }}</div>
                                        <small class="text-muted">Docker repository</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('repository_tags', repository=repo) }}" 
                                       class="btn btn-outline-primary">
                                        <i class="bi bi-tag me-1"></i>
                                        View Tags
                                    </a>
                                    <button class="btn btn-outline-success" onclick="scanRepository('{{ repo }}')">
                                        <i class="bi bi-play-fill me-1"></i>
                                        Scan
                                    </button>
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">Never</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Bulk Actions Footer -->
        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-info" id="selectedRepositoryCount">0 repositories selected</span>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-primary" id="bulkScanBtn" onclick="bulkScanSelected()" disabled>
                        <i class="bi bi-play-fill me-1"></i>
                        Bulk Scan Selected
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSelection()">
                        <i class="bi bi-x-circle me-1"></i>
                        Clear Selection
                    </button>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-server fs-1 mb-3"></i>
            <h4>No Registry Connected</h4>
            <p class="mb-4">Configure your Docker registry connection to start scanning repositories</p>
            <div class="alert alert-info d-inline-block">
                <strong>Registry Configuration:</strong><br>
                Set the following environment variables:<br>
                <code>DOCKER_REGISTRY_URL</code>, <code>DOCKER_USERNAME</code>, <code>DOCKER_PASSWORD</code>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Batch Scan Modal -->
<div class="modal fade" id="batchScanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-server me-2"></i>
                    Registry Batch Scan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanProgress" class="d-none">
                    <h6>Scan Progress</h6>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between text-muted">
                        <small id="scanStatus">Preparing scan...</small>
                        <small id="scanCounter">0 / 0</small>
                    </div>
                </div>
                
                <div id="scanConfig">
                    <h6>Scan Configuration</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Selected Repositories</label>
                            <div id="selectedReposList" class="form-control" style="height: 150px; overflow-y: auto;">
                                <em class="text-muted">No repositories selected</em>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Scan Options</label>
                            <div class="mb-3">
                                <label class="form-label">Max Images per Repository</label>
                                <select class="form-select" id="maxImagesPerRepo">
                                    <option value="3">3 images</option>
                                    <option value="5" selected>5 images</option>
                                    <option value="10">10 images</option>
                                    <option value="20">20 images</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableCVE" checked>
                                <label class="form-check-label" for="enableCVE">
                                    Enable CVE enrichment
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="scanResults" class="d-none">
                    <h6>Scan Results</h6>
                    <div id="scanResultsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-gradient" id="startScanBtn" onclick="executeBatchScan()">
                    <i class="bi bi-play-fill me-1"></i>
                    Start Scan
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedRepositories = new Set();

// Repository filtering
function filterRepositories() {
    const searchTerm = document.getElementById('repositorySearch').value.toLowerCase();
    const rows = document.querySelectorAll('.repository-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const repoName = row.getAttribute('data-repository').toLowerCase();
        if (repoName.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
}

// Repository selection
function toggleAllRepositories() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.repository-checkbox');
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('.repository-row');
        if (row.style.display !== 'none') {
            checkbox.checked = selectAll;
            updateRepositorySelection(checkbox);
        }
    });
}

function selectAllVisible() {
    const visibleCheckboxes = document.querySelectorAll('.repository-row:not([style*="display: none"]) .repository-checkbox');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
        updateRepositorySelection(checkbox);
    });
}

function updateRepositorySelection(checkbox) {
    if (checkbox.checked) {
        selectedRepositories.add(checkbox.value);
    } else {
        selectedRepositories.delete(checkbox.value);
    }
    
    updateSelectionUI();
}

function updateSelectionUI() {
    const count = selectedRepositories.size;
    const countBadge = document.getElementById('selectedRepositoryCount');
    const bulkBtn = document.getElementById('bulkScanBtn');
    
    countBadge.textContent = `${count} repositories selected`;
    bulkBtn.disabled = count === 0;
}

function clearSelection() {
    selectedRepositories.clear();
    document.querySelectorAll('.repository-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelectionUI();
}

// Scan functions
function scanRepository(repository) {
    // Single repository scan
    const repositories = [repository];
    executeScan(repositories, 5);
}

function scanPopularImages() {
    const popularRepos = ['nginx', 'alpine', 'ubuntu', 'node', 'python', 'mysql', 'postgres', 'redis'];
    const availablePopular = popularRepos.filter(repo => 
        Array.from(document.querySelectorAll('.repository-checkbox')).some(cb => cb.value === repo)
    );
    
    if (availablePopular.length > 0) {
        executeScan(availablePopular, 3);
    } else {
        alert('No popular repositories found in registry');
    }
}

function bulkScanSelected() {
    if (selectedRepositories.size === 0) {
        alert('Please select repositories to scan');
        return;
    }
    
    // Update modal with selected repositories
    updateBatchScanModal();
    new bootstrap.Modal(document.getElementById('batchScanModal')).show();
}

function updateBatchScanModal() {
    const reposList = document.getElementById('selectedReposList');
    if (selectedRepositories.size > 0) {
        reposList.innerHTML = Array.from(selectedRepositories).map(repo => 
            `<div class="badge bg-primary me-1 mb-1">${repo}</div>`
        ).join('');
    } else {
        reposList.innerHTML = '<em class="text-muted">No repositories selected</em>';
    }
}

async function executeBatchScan() {
    const repositories = Array.from(selectedRepositories);
    const maxImages = parseInt(document.getElementById('maxImagesPerRepo').value) * repositories.length;
    
    // Show progress
    document.getElementById('scanConfig').classList.add('d-none');
    document.getElementById('scanProgress').classList.remove('d-none');
    document.getElementById('startScanBtn').disabled = true;
    
    try {
        const response = await fetch('/registry/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                repositories: repositories,
                max_images: maxImages
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Show results
        showScanResults(result);
        
    } catch (error) {
        alert(`Scan failed: ${error.message}`);
        resetBatchScanModal();
    }
}

function showScanResults(result) {
    document.getElementById('scanProgress').classList.add('d-none');
    document.getElementById('scanResults').classList.remove('d-none');
    
    const resultsList = document.getElementById('scanResultsList');
    resultsList.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="bi bi-check-circle me-2"></i>Scan Completed Successfully!</h6>
            <ul class="mb-0">
                <li>Total images scanned: ${result.total_scanned}</li>
                <li>Images queued: ${result.total_queued}</li>
                <li>Registry scan ID: <code>${result.registry_scan_id}</code></li>
            </ul>
        </div>
        <div class="text-center">
            <a href="/registry/scan/${result.registry_scan_id}" class="btn btn-primary">
                <i class="bi bi-eye me-1"></i>View Detailed Results
            </a>
        </div>
    `;
}

function resetBatchScanModal() {
    document.getElementById('scanConfig').classList.remove('d-none');
    document.getElementById('scanProgress').classList.add('d-none');
    document.getElementById('scanResults').classList.add('d-none');
    document.getElementById('startScanBtn').disabled = false;
}

function refreshRegistryData() {
    window.location.reload();
}

function exportRepositoryList() {
    const repos = Array.from(document.querySelectorAll('.repository-checkbox')).map(cb => cb.value);
    const dataStr = JSON.stringify({
        registry_url: "{{ registry_data.registry_url }}",
        repositories: repos,
        exported_at: new Date().toISOString()
    }, null, 2);
    
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `registry-repositories-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Repository checkboxes
    document.querySelectorAll('.repository-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateRepositorySelection(this);
        });
    });
    
    // Modal reset on hide
    document.getElementById('batchScanModal').addEventListener('hidden.bs.modal', function() {
        resetBatchScanModal();
    });
    
    updateSelectionUI();
});
</script>

{% endblock %}