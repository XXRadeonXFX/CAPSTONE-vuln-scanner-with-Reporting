{% extends "base.html" %}

{% block title %}All Reports - Vulnerability Scanner{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-white">Dashboard</a></li>
                <li class="breadcrumb-item active text-white-50">All Reports</li>
            </ol>
        </nav>
        <h1 class="h2 text-white mb-1">
            <i class="bi bi-file-earmark-text me-2"></i>
            Scan Reports
        </h1>
        <p class="text-white-50 mb-0">View and manage all vulnerability scan reports</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light" onclick="window.location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Refresh
        </button>
        <button class="btn btn-light" onclick="showScanModal()">
            <i class="bi bi-plus-circle me-1"></i>
            New Scan
        </button>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="searchInput" class="form-label">Search Images</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search by image name..." onkeyup="filterReports()">
                </div>
            </div>
            <div class="col-md-3">
                <label for="riskFilter" class="form-label">Risk Level</label>
                <select class="form-select" id="riskFilter" onchange="filterReports()">
                    <option value="">All Risk Levels</option>
                    <option value="CRITICAL">Critical Risk</option>
                    <option value="HIGH">High Risk</option>
                    <option value="MEDIUM">Medium Risk</option>
                    <option value="LOW">Low Risk</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="enrichmentFilter" class="form-label">CVE Enhancement</label>
                <select class="form-select" id="enrichmentFilter" onchange="filterReports()">
                    <option value="">All Reports</option>
                    <option value="true">CVE Enhanced</option>
                    <option value="false">Basic Scan</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    <i class="bi bi-x-circle me-1"></i>
                    Clear
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reports Grid -->
<div class="row" id="reportsGrid">
    {% if reports %}
        {% for report in reports %}
        <div class="col-xl-4 col-lg-6 mb-4 report-card" 
             data-image="{{ report.image.lower() }}" 
             data-risk="{{ (report.summary | risk_level)[0] }}"
             data-enriched="{{ report.enriched | string | lower }}">
            <div class="card h-100 report-item">
                <div class="card-header bg-transparent">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">
                                <i class="bi bi-box me-1"></i>
                                {{ report.image }}
                            </h6>
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                {{ report.created_at | datetime }}
                            </small>
                        </div>
                        <div class="d-flex flex-column gap-1 align-items-end">
                            {% set risk_level, risk_class = report.summary | risk_level %}
                            <span class="badge bg-{{ risk_class }}">{{ risk_level }}</span>
                            {% if report.enriched %}
                                <span class="badge bg-info" title="CVE Enhanced">
                                    <i class="bi bi-database"></i>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Vulnerability Summary -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Vulnerability Summary</h6>
                        <div class="row g-2 text-center">
                            {% for severity, count in report.summary.items() %}
                            <div class="col-3">
                                <div class="p-2 rounded" style="background: rgba({{ '220, 53, 69' if severity == 'CRITICAL' else '253, 126, 20' if severity == 'HIGH' else '255, 193, 7' if severity == 'MEDIUM' else '40, 167, 69' }}, 0.1);">
                                    <div class="h6 mb-0 text-{{ severity | severity_badge }}">{{ count }}</div>
                                    <small class="text-muted">{{ severity }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-stopwatch me-2 text-muted"></i>
                                <div>
                                    <div class="fw-semibold">{{ report.elapsed or 0 }}s</div>
                                    <small class="text-muted">Scan time</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            {% set total_vulns = report.summary.CRITICAL + report.summary.HIGH + report.summary.MEDIUM + report.summary.LOW %}
                            <div class="d-flex align-items-center">
                                <i class="bi bi-bug me-2 text-muted"></i>
                                <div>
                                    <div class="fw-semibold">{{ total_vulns }}</div>
                                    <small class="text-muted">Total issues</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bars for Risk Visualization -->
                    <div class="mb-3">
                        <small class="text-muted mb-1 d-block">Risk Distribution</small>
                        {% set max_vulns = [report.summary.CRITICAL, report.summary.HIGH, report.summary.MEDIUM, report.summary.LOW] | max %}
                        {% if max_vulns > 0 %}
                            {% for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'] %}
                                {% set count = report.summary[severity] %}
                                {% if count > 0 %}
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge bg-{{ severity | severity_badge }} me-2" style="width: 60px;">{{ severity }}</span>
                                        <div class="progress flex-grow-1" style="height: 6px;">
                                            <div class="progress-bar bg-{{ severity | severity_badge }}" 
                                                 style="width: {{ (count / max_vulns * 100) }}%"></div>
                                        </div>
                                        <span class="ms-2 small text-muted">{{ count }}</span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-success">
                                <i class="bi bi-shield-check me-1"></i>
                                <small>No vulnerabilities found</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-hash me-1"></i>
                            {{ report.id[:8] }}...
                        </small>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('report', report_id=report.id) }}" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-eye me-1"></i>
                                View Details
                            </a>
                            <button class="btn btn-outline-secondary" onclick="shareReport('{{ report.id }}')">
                                <i class="bi bi-share"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox fs-1 mb-3 text-muted"></i>
                    <h4>No scan reports found</h4>
                    <p class="text-muted mb-4">Get started by running your first vulnerability scan</p>
                    <button class="btn btn-gradient" onclick="showScanModal()">
                        <i class="bi bi-search me-1"></i>
                        Start First Scan
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if total > limit %}
<nav aria-label="Reports pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}&limit={{ limit }}">
                    <i class="bi bi-chevron-left"></i>
                    Previous
                </a>
            </li>
        {% endif %}
        
        {% set start_page = [1, page - 2] | max %}
        {% set end_page = [start_page + 4, (total // limit) + 1] | min %}
        
        {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
                <li class="page-item active">
                    <span class="page-link">{{ p }}</span>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ p }}&limit={{ limit }}">{{ p }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}&limit={{ limit }}">
                    Next
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
    
    <div class="text-center text-muted">
        Showing {{ ((page - 1) * limit + 1) }} to {{ [page * limit, total] | min }} of {{ total }} reports
    </div>
</nav>
{% endif %}

<!-- Bulk Actions (Future Feature) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <div class="toast align-items-center text-white bg-success border-0" id="actionToast" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle me-2"></i>
                <span id="toastMessage">Action completed successfully</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filter functionality
function filterReports() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const riskFilter = document.getElementById('riskFilter').value;
    const enrichmentFilter = document.getElementById('enrichmentFilter').value;
    const reportCards = document.querySelectorAll('.report-card');
    
    let visibleCount = 0;
    
    reportCards.forEach(card => {
        const image = card.getAttribute('data-image');
        const risk = card.getAttribute('data-risk');
        const enriched = card.getAttribute('data-enriched');
        
        let showCard = true;
        
        // Search filter
        if (searchTerm && !image.includes(searchTerm)) {
            showCard = false;
        }
        
        // Risk filter
        if (riskFilter && risk !== riskFilter) {
            showCard = false;
        }
        
        // Enrichment filter
        if (enrichmentFilter && enriched !== enrichmentFilter) {
            showCard = false;
        }
        
        if (showCard) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    updateNoResultsMessage(visibleCount);
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('riskFilter').value = '';
    document.getElementById('enrichmentFilter').value = '';
    filterReports();
}

function updateNoResultsMessage(visibleCount) {
    let noResultsDiv = document.getElementById('noResults');
    
    if (visibleCount === 0) {
        if (!noResultsDiv) {
            noResultsDiv = document.createElement('div');
            noResultsDiv.id = 'noResults';
            noResultsDiv.className = 'col-12';
            noResultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-search fs-1 mb-3 text-muted"></i>
                        <h4>No reports match your filters</h4>
                        <p class="text-muted mb-4">Try adjusting your search criteria</p>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle me-1"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('reportsGrid').appendChild(noResultsDiv);
        }
        noResultsDiv.style.display = 'block';
    } else if (noResultsDiv) {
        noResultsDiv.style.display = 'none';
    }
}

// Share functionality
function shareReport(reportId) {
    const url = `${window.location.origin}/report/${reportId}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Vulnerability Report',
            text: `Check out this vulnerability scan report`,
            url: url
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            showToast('Report link copied to clipboard!');
        });
    }
}

// Toast notification
function showToast(message) {
    document.getElementById('toastMessage').textContent = message;
    const toast = new bootstrap.Toast(document.getElementById('actionToast'));
    toast.show();
}

// Auto-refresh functionality
let autoRefresh = false;
let refreshInterval;

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const btn = document.querySelector('[onclick="toggleAutoRefresh()"]');
    
    if (autoRefresh) {
        refreshInterval = setInterval(() => {
            window.location.reload();
        }, 30000); // 30 seconds
        btn.innerHTML = '<i class="bi bi-pause-circle me-1"></i>Stop Auto-refresh';
        btn.classList.remove('btn-outline-light');
        btn.classList.add('btn-warning');
        showToast('Auto-refresh enabled (30s interval)');
    } else {
        clearInterval(refreshInterval);
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Auto-refresh';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-light');
        showToast('Auto-refresh disabled');
    }
}

// Enhanced card interactions
document.addEventListener('DOMContentLoaded', function() {
    const reportItems = document.querySelectorAll('.report-item');
    
    reportItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.1)';
        });
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K: Focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
    
    // Ctrl/Cmd + N: New scan
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        showScanModal();
    }
});
</script>

<style>
.report-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    overflow: hidden;
}

.progress {
    border-radius: 3px;
}

.badge {
    font-size: 0.7em;
    font-weight: 600;
}

.page-link {
    color: #667eea;
    border-color: #dee2e6;
}

.page-link:hover {
    color: #5a67d8;
    background-color: #e3f2fd;
    border-color: #667eea;
}

.page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
}

.btn-group-sm > .btn {
    font-size: 0.8rem;
}

.toast {
    backdrop-filter: blur(10px);
}

@media (max-width: 768px) {
    .col-xl-4, .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn-group {
        flex-direction: column;
    }
}
</style>
{% endblock %}